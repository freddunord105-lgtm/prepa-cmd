<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pr√©pa Commandes ‚Äî SAMEMO</title>
<style>
:root{--primary:#0f766e;--success:#16a34a;--danger:#e11d48;--bg:#f8fafc;--card:#fff;--border:#e5e7eb;--muted:#64748b;--disabled:#94a3b8;}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,sans-serif;background:var(--bg)}
.app{max-width:520px;margin:auto;padding:16px}
.header{text-align:center;margin-bottom:16px}
.logo{font-size:28px;font-weight:900;color:var(--primary)}
.subtitle{font-size:14px;color:#475569}
.card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 10px 25px rgba(0,0,0,.06)}
h2{text-align:center;margin:0}
button{width:100%;padding:14px;border:none;border-radius:12px;font-weight:800;cursor:pointer;margin-top:8px}
.primary{background:var(--primary);color:#fff}
.success{background:var(--success);color:#fff}
.danger{background:var(--danger);color:#fff}
.disabled{background:var(--disabled);cursor:not-allowed}
.list-item{padding:12px;border-bottom:1px solid var(--border)}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800}
.badge.todo{background:#fff7ed;color:#9a3412}
.badge.ready{background:#eff6ff;color:#1d4ed8}
.badge.done{background:#ecfdf5;color:#065f46}
.hidden{display:none}
.small{font-size:12px;color:var(--muted)}
.progress{text-align:center;font-weight:900;margin:10px 0}
.prep-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.back{font-size:22px;cursor:pointer}
.msg{margin-top:10px;padding:10px 12px;border-radius:12px;font-weight:900}
.msg.info{background:#f1f5f9;color:#0f172a}
.msg.err{background:#fff1f2;color:#9f1239}
.hr{height:1px;background:var(--border);margin:12px 0}
.kv{display:flex;justify-content:space-between;gap:10px;font-weight:800}
.kv span{color:var(--muted);font-weight:700}

#qr-reader{
  width:100%;
  border-radius:16px;
  overflow:hidden;
  border:1px solid var(--border);
}
</style>
</head>
<body>
<div class="app">

<div class="header">
  <div class="logo">SAMEMO</div>
  <div class="subtitle">Pr√©paration de commandes</div>
</div>

<!-- LISTE -->
<div id="screen-list" class="card">
  <h2>üìã Commandes</h2>
  <div class="hr"></div>
  <div id="orders"></div>
  <div class="hr"></div>
  <div id="tamponRecap" class="small"></div>
</div>

<!-- PREPA -->
<div id="screen-prep" class="card hidden">
  <div class="prep-header">
    <div class="back" onclick="goBack()">‚¨Ö</div>
    <h2 id="cmdTitle"></h2>
  </div>

  <div id="progress" class="progress"></div>

  <div class="small">Scanne les produits (ici on simule). Chaque scan produit = <b>-1 zone tampon</b>.</div>
  <div class="hr"></div>

  <div id="lines"></div>
  <div id="prepMsg"></div>

  <button id="toFinishBtn" class="disabled" disabled>Commande pr√™te ‚Üí Scanner bac</button>
</div>

<!-- FIN : SCAN BAC CAMERA -->
<div id="screen-finish" class="card hidden">
  <h2>üì¶ Scanner le bac (cam√©ra)</h2>
  <div class="small">Place le QR du bac dans le cadre. (ex: BAC-001)</div>

  <div class="hr"></div>

  <div id="qr-reader"></div>

  <button id="startCamBtn" class="primary">‚ñ∂ D√©marrer cam√©ra</button>
  <button id="stopCamBtn" class="disabled" disabled>‚èπ Stop cam√©ra</button>

  <div id="finishMsg"></div>

  <button class="primary" onclick="backToListFromFinish()" style="margin-top:12px">‚¨Ö Retour liste</button>
</div>

<!-- END -->
<div id="screen-end" class="card hidden">
  <h2>üéâ Toutes les commandes ont √©t√© trait√©es</h2>
  <button class="success" onclick="location.reload()">üîÅ Nouvelle session</button>
</div>

</div>

<!-- html5-qrcode (cam√©ra QR) -->
<script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>

<script>
/* ========= DATA TEST ========= */
// Commandes
const ORDERS = [
  { id:"CMD-001", client:"Client Alpha", status:"TODO", bin:null },
  { id:"CMD-002", client:"Client Beta",  status:"TODO", bin:null }
];

// Lignes de commande
const LINES = {
  "CMD-001":[
    { code:"P001", name:"Mandarine", qty:2 },
    { code:"P002", name:"Banane", qty:1 }
  ],
  "CMD-002":[
    { code:"P001", name:"Mandarine", qty:1 },
    { code:"P003", name:"Pomme", qty:2 }
  ]
};

// ‚úÖ Zone tampon = dispo pour pr√©pa (scan produit => -1)
const ZONE_TAMPON = { "P001": 3, "P002": 1, "P003": 1 };

/* ========= DOM ========= */
const screenList = document.getElementById("screen-list");
const screenPrep = document.getElementById("screen-prep");
const screenFinish = document.getElementById("screen-finish");
const screenEnd  = document.getElementById("screen-end");

const ordersDiv = document.getElementById("orders");
const tamponRecap = document.getElementById("tamponRecap");

const cmdTitle = document.getElementById("cmdTitle");
const progressEl = document.getElementById("progress");
const linesDiv = document.getElementById("lines");
const prepMsg = document.getElementById("prepMsg");
const toFinishBtn = document.getElementById("toFinishBtn");

const startCamBtn = document.getElementById("startCamBtn");
const stopCamBtn  = document.getElementById("stopCamBtn");
const finishMsg   = document.getElementById("finishMsg");

/* ========= STATE ========= */
let currentCmd = null;
let lines = {}; // code -> {name, qty}
let done  = {}; // code -> picked qty

// QR Scanner instance
let qrScanner = null;
let cameraRunning = false;

/* ========= HELPERS ========= */
function msg(el, type, text){
  if(!text){ el.innerHTML=""; return; }
  el.innerHTML = `<div class="msg ${type}">${text}</div>`;
}
function getOrder(id){ return ORDERS.find(o=>o.id===id); }
function showOnly(which){
  [screenList, screenPrep, screenFinish, screenEnd].forEach(s=>s.classList.add("hidden"));
  which.classList.remove("hidden");
}
function recapTampon(){
  const parts = Object.keys(ZONE_TAMPON).sort().map(k=>`${k}:${ZONE_TAMPON[k]}`);
  tamponRecap.textContent = parts.length ? `Zone tampon dispo ‚Üí ${parts.join(" ‚Ä¢ ")}` : "";
}
function allDone(){ return ORDERS.every(o=>o.status==="DONE"); }

/* ========= LISTE ========= */
function loadOrders(){
  ordersDiv.innerHTML="";
  recapTampon();

  ORDERS.forEach(o=>{
    const d = document.createElement("div");
    d.className = "list-item";

    const badge =
      o.status==="DONE" ? `<span class="badge done">Trait√©e</span>` :
      o.status==="READY" ? `<span class="badge ready">Pr√™te</span>` :
      `<span class="badge todo">√Ä pr√©parer</span>`;

    const action =
      o.status==="TODO" ? `<button class="primary" onclick="startPrep('${o.id}')">Ouvrir</button>` :
      o.status==="READY" ? `<button class="success" onclick="openFinish('${o.id}')">Scanner bac</button>` :
      `<div class="small" style="margin-top:6px">‚úî Bac: <strong>${o.bin}</strong></div>`;

    d.innerHTML = `
      <strong>${o.id}</strong><br>
      ${o.client}<br>
      ${badge}<br>
      ${action}
    `;
    ordersDiv.appendChild(d);
  });

  if(allDone()) showOnly(screenEnd);
  else showOnly(screenList);
}

/* ========= PREPA ========= */
function startPrep(id){
  currentCmd = id;
  lines = {};
  done = {};
  msg(prepMsg, "info", "");

  LINES[id].forEach(l=>{
    lines[l.code] = { name:l.name, qty:l.qty };
    done[l.code] = 0;
  });

  cmdTitle.textContent = `Commande ${id}`;
  toFinishBtn.disabled = true;
  toFinishBtn.className = "disabled";

  renderLines();
  showOnly(screenPrep);
}

function renderLines(){
  linesDiv.innerHTML = "";
  let total=0, ok=0;

  Object.keys(lines).forEach(code=>{
    total += lines[code].qty;
    ok += done[code];

    const dispo = ZONE_TAMPON[code] ?? 0;

    const d = document.createElement("div");
    d.className = "list-item";
    d.innerHTML = `
      <div class="kv">
        <div><strong>${lines[code].name}</strong> <span>(${code})</span></div>
        <div><span>Tampon</span> ${dispo}</div>
      </div>
      <div style="margin-top:6px;font-weight:800">${done[code]} / ${lines[code].qty} ${done[code]===lines[code].qty?"‚úî":""}</div>
      <button class="primary" onclick="scanProduct('${code}')">Simuler scan ${code}</button>
    `;
    linesDiv.appendChild(d);
  });

  progressEl.textContent = `Avancement : ${ok} / ${total}`;

  if(ok === total){
    toFinishBtn.disabled = false;
    toFinishBtn.className = "success";
    msg(prepMsg, "info", "Commande pr√™te ‚úÖ (maintenant seulement : scanner le bac).");
  } else {
    msg(prepMsg, "info", "Scanne les produits demand√©s. Chaque scan enl√®ve 1 en zone tampon.");
  }
}

function scanProduct(code){
  if(!lines[code]){
    msg(prepMsg, "err", "Produit NON demand√© dans cette commande.");
    return;
  }
  if(done[code] >= lines[code].qty){
    msg(prepMsg, "err", "Quantit√© d√©j√† compl√®te pour ce produit.");
    return;
  }
  const dispo = ZONE_TAMPON[code] ?? 0;
  if(dispo <= 0){
    msg(prepMsg, "err", "Zone tampon vide (rupture) pour ce produit.");
    return;
  }

  // ‚úÖ scan produit = -1 zone tampon
  ZONE_TAMPON[code] = dispo - 1;
  done[code]++;

  msg(prepMsg, "info", `OK : ${code} ‚Üí zone tampon -1.`);
  renderLines();
  recapTampon();
}

toFinishBtn.onclick = () => {
  const o = getOrder(currentCmd);
  o.status = "READY";
  openFinish(currentCmd);
};

/* ========= FIN : SCAN BAC CAMERA ========= */
function openFinish(cmdId){
  currentCmd = cmdId;
  msg(finishMsg, "info", "D√©marre la cam√©ra puis scanne le QR du bac.");
  showOnly(screenFinish);

  // init scanner si besoin
  if(!qrScanner){
    qrScanner = new Html5Qrcode("qr-reader");
  }

  // buttons state
  startCamBtn.disabled = false;
  startCamBtn.className = "primary";
  stopCamBtn.disabled = true;
  stopCamBtn.className = "disabled";
}

async function startBinScanner(){
  if(cameraRunning) return;

  // iOS: mieux d‚Äôutiliser la cam√©ra arri√®re
  const config = {
    fps: 10,
    qrbox: { width: 250, height: 250 },
    aspectRatio: 1.0
  };

  try{
    cameraRunning = true;
    startCamBtn.disabled = true;
    startCamBtn.className = "disabled";
    stopCamBtn.disabled = false;
    stopCamBtn.className = "danger";

    await qrScanner.start(
      { facingMode: "environment" },
      config,
      (decodedText) => onBinDecoded(decodedText),
      () => {} // ignore scan errors frame-by-frame
    );

    msg(finishMsg, "info", "Cam√©ra active. Scanne le QR bac‚Ä¶");
  }catch(e){
    cameraRunning = false;
    startCamBtn.disabled = false;
    startCamBtn.className = "primary";
    stopCamBtn.disabled = true;
    stopCamBtn.className = "disabled";

    const err = (e && e.message) ? e.message : String(e);
    msg(finishMsg, "err",
      "Cam√©ra refus√©e ou indisponible. V√©rifie Safari > R√©glages > Cam√©ra, et que tu es en HTTPS. D√©tail: " + err
    );
  }
}

async function stopBinScanner(){
  if(!qrScanner || !cameraRunning) return;
  try{
    await qrScanner.stop();
    await qrScanner.clear();
  }catch(_){}
  cameraRunning = false;

  startCamBtn.disabled = false;
  startCamBtn.className = "primary";
  stopCamBtn.disabled = true;
  stopCamBtn.className = "disabled";
  msg(finishMsg, "info", "Cam√©ra arr√™t√©e.");
}

function normalize(text){
  return (text || "").trim();
}

async function onBinDecoded(decodedText){
  const bin = normalize(decodedText);

  // petit filtre : tu peux imposer un format "BAC-"
  // si tu veux strict :
  // if(!bin.startsWith("BAC-")) return;

  const o = getOrder(currentCmd);
  if(!o || o.status !== "READY"){
    msg(finishMsg, "err", "Commande pas pr√™te (status incorrect).");
    return;
  }

  // stop cam√©ra d√®s qu‚Äôon a un bac pour √©viter double lecture
  await stopBinScanner();

  // ‚úÖ finalize
  o.status = "DONE";
  o.bin = bin;

  msg(finishMsg, "info", `‚úÖ Commande ${o.id} pos√©e dans ${bin}.`);
  loadOrders();
}

startCamBtn.onclick = startBinScanner;
stopCamBtn.onclick = stopBinScanner;

function backToListFromFinish(){
  stopBinScanner();
  showOnly(screenList);
  loadOrders();
}

/* ========= NAV ========= */
function goBack(){
  stopBinScanner();
  currentCmd = null;
  showOnly(screenList);
  loadOrders();
}

/* INIT */
loadOrders();
</script>
</body>
</html>
