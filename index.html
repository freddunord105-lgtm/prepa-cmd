<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pr√©pa Commandes ‚Äî SAMEMO</title>
<style>
:root{--primary:#0f766e;--success:#16a34a;--danger:#e11d48;--bg:#f8fafc;--card:#fff;--border:#e5e7eb;--muted:#64748b;--disabled:#94a3b8;}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,sans-serif;background:var(--bg)}
.app{max-width:520px;margin:auto;padding:16px}
.header{text-align:center;margin-bottom:16px}
.logo{font-size:28px;font-weight:900;color:var(--primary)}
.subtitle{font-size:14px;color:#475569}
.card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 10px 25px rgba(0,0,0,.06)}
h2{text-align:center;margin:0}
button{width:100%;padding:14px;border:none;border-radius:12px;font-weight:800;cursor:pointer;margin-top:8px}
.primary{background:var(--primary);color:#fff}
.success{background:var(--success);color:#fff}
.danger{background:var(--danger);color:#fff}
.disabled{background:var(--disabled);cursor:not-allowed}
.list-item{padding:12px;border-bottom:1px solid var(--border)}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800}
.badge.todo{background:#fff7ed;color:#9a3412}
.badge.ready{background:#eff6ff;color:#1d4ed8}
.badge.done{background:#ecfdf5;color:#065f46}
.hidden{display:none}
.small{font-size:12px;color:var(--muted)}
.progress{text-align:center;font-weight:900;margin:10px 0}
.prep-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.back{font-size:22px;cursor:pointer}
.msg{margin-top:10px;padding:10px 12px;border-radius:12px;font-weight:900}
.msg.info{background:#f1f5f9;color:#0f172a}
.msg.err{background:#fff1f2;color:#9f1239}
.hr{height:1px;background:var(--border);margin:12px 0}
.kv{display:flex;justify-content:space-between;gap:10px;font-weight:800}
.kv span{color:var(--muted);font-weight:700}

#qr-reader{
  width:100%;
  border-radius:16px;
  overflow:hidden;
  border:1px solid var(--border);
}
input, select{
  width:100%;
  padding:12px;
  border:1px solid var(--border);
  border-radius:12px;
  font-weight:800;
}
</style>
</head>
<body>
<div class="app">

<div class="header">
  <div class="logo">SAMEMO</div>
  <div class="subtitle">Pr√©paration de commandes</div>
</div>

<!-- LISTE -->
<div id="screen-list" class="card">
  <h2>üìã Commandes</h2>
  <div class="hr"></div>
  <div id="orders"></div>
  <div class="hr"></div>
  <div id="tamponRecap" class="small"></div>
  <div id="listMsg"></div>
</div>

<!-- PREPA -->
<div id="screen-prep" class="card hidden">
  <div class="prep-header">
    <div class="back" onclick="goBack()">‚¨Ö</div>
    <h2 id="cmdTitle"></h2>
  </div>

  <div id="progress" class="progress"></div>
  <div class="small">Scanne les produits (cam√©ra). Chaque scan valide 1 unit√©.</div>
  <div class="hr"></div>

  <div id="lines"></div>
  <div id="prepMsg"></div>

  <button id="toFinishBtn" class="disabled" disabled>Commande pr√™te ‚Üí Scanner bac</button>
</div>

<!-- FIN : SCAN BAC CAMERA -->
<div id="screen-finish" class="card hidden">
  <h2>üì¶ Scanner le bac (cam√©ra)</h2>
  <div class="small">Place le QR du bac dans le cadre. (ex: BAC-001)</div>

  <div class="hr"></div>

  <div id="qr-reader"></div>

  <button id="startCamBtn" class="primary">‚ñ∂ D√©marrer cam√©ra</button>
  <button id="stopCamBtn" class="disabled" disabled>‚èπ Stop cam√©ra</button>

  <div id="finishMsg"></div>

  <button class="primary" onclick="backToListFromFinish()" style="margin-top:12px">‚¨Ö Retour liste</button>
</div>

<!-- END -->
<div id="screen-end" class="card hidden">
  <h2>üéâ Toutes les commandes ont √©t√© trait√©es</h2>
  <button class="success" onclick="location.reload()">üîÅ Nouvelle session</button>
</div>

</div>

<!-- html5-qrcode (cam√©ra QR) -->
<script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>

<script>
/* ================== CONFIG FRONT ================== */
/**
 * ‚ö†Ô∏è Mets ici l‚ÄôURL de TA Web App Apps Script (d√©ploy√©e).
 * Exemple: https://script.google.com/macros/s/AKfycb.../exec
 */
const API_BASE = "PASTE_YOUR_APPS_SCRIPT_WEBAPP_URL_HERE";

// actor: identifiant op√©rateur (tu peux le r√©cup√©rer via params, login, etc.)
let ACTOR = localStorage.getItem("SAMEMO_ACTOR") || "OP-1";

/* ================== DOM ================== */
const screenList = document.getElementById("screen-list");
const screenPrep = document.getElementById("screen-prep");
const screenFinish = document.getElementById("screen-finish");
const screenEnd  = document.getElementById("screen-end");

const ordersDiv = document.getElementById("orders");
const tamponRecap = document.getElementById("tamponRecap");
const listMsg = document.getElementById("listMsg");

const cmdTitle = document.getElementById("cmdTitle");
const progressEl = document.getElementById("progress");
const linesDiv = document.getElementById("lines");
const prepMsg = document.getElementById("prepMsg");
const toFinishBtn = document.getElementById("toFinishBtn");

const startCamBtn = document.getElementById("startCamBtn");
const stopCamBtn  = document.getElementById("stopCamBtn");
const finishMsg   = document.getElementById("finishMsg");

/* ================== STATE ================== */
let currentCmd = null;

// commande courante (depuis API)
let orderLines = []; // [{code,name,qty,picked}]
let productsByCode = {}; // cache produit -> {code,name,photo}

// Scanner instance
let qrScanner = null;
let cameraRunning = false;

// Mode scan: "product" (picking) ou "bin" (fin)
let scanMode = null;
// Contexte du scan produit
let scanProductCode = null;

/* ================== HELPERS ================== */
function msg(el, type, text){
  if(!text){ el.innerHTML=""; return; }
  el.innerHTML = `<div class="msg ${type}">${text}</div>`;
}
function showOnly(which){
  [screenList, screenPrep, screenFinish, screenEnd].forEach(s=>s.classList.add("hidden"));
  which.classList.remove("hidden");
}
function normalize(text){ return (text || "").trim(); }

function isSecureContextOk(){
  if (location.protocol === "https:") return true;
  if (location.hostname === "localhost" || location.hostname === "127.0.0.1") return true;
  return false;
}

async function apiGet(params){
  const url = new URL(API_BASE);
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
  const r = await fetch(url.toString(), { method:"GET" });
  if(!r.ok) throw new Error("GET failed");
  return await r.json();
}

async function apiPost(body){
  const r = await fetch(API_BASE, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });
  const j = await r.json();
  if(!j || j.success === false) throw new Error(j?.error || "POST failed");
  return j;
}

/* ================== LISTE (API) ================== */
async function loadOrders(){
  ordersDiv.innerHTML="";
  msg(listMsg, "info", "Chargement‚Ä¶");

  try{
    const orders = await apiGet({ action:"orders" });

    // recap tampon (optionnel) : on calcule via mouvements si tu veux un endpoint d√©di√© plus tard.
    // Ici on enl√®ve le fake: on n'affiche plus ZONE_TAMPON.
    tamponRecap.textContent = "";

    orders.forEach(o=>{
      const d = document.createElement("div");
      d.className = "list-item";

      const badge =
        o.status==="DONE" ? `<span class="badge done">Trait√©e</span>` :
        o.status==="READY" ? `<span class="badge ready">Pr√™te</span>` :
        `<span class="badge todo">√Ä pr√©parer</span>`;

      const action =
        (o.status==="TODO" || o.status==="READY")
          ? `<button class="primary" onclick="startPrep('${o.id}')">Ouvrir</button>`
          : `<div class="small" style="margin-top:6px">‚úî Bac: <strong>${o.bin || "-"}</strong></div>`;

      d.innerHTML = `
        <strong>${o.id}</strong><br>
        ${o.client}<br>
        ${badge}<br>
        ${action}
      `;
      ordersDiv.appendChild(d);
    });

    msg(listMsg, "info", "");
    if(Array.isArray(orders) && orders.length && orders.every(o=>o.status==="DONE")){
      showOnly(screenEnd);
    }else{
      showOnly(screenList);
    }
  }catch(e){
    msg(listMsg, "err", "Erreur API (orders). V√©rifie API_BASE et le d√©ploiement Apps Script.");
    showOnly(screenList);
  }
}

/* ================== PR√âPA (API) ================== */
async function startPrep(id){
  currentCmd = id;
  msg(prepMsg, "info", "Chargement commande‚Ä¶");
  toFinishBtn.disabled = true;
  toFinishBtn.className = "disabled";

  try{
    orderLines = await apiGet({ action:"orderLines", id });
    cmdTitle.textContent = `Commande ${id}`;

    // Normalise picked si pas pr√©sent (si ton backend ne renvoie pas picked, √ßa sera 0)
    orderLines = (orderLines || []).map(l => ({
      code: l.code,
      name: l.name,
      qty: Number(l.qty) || 0,
      picked: Number(l.picked) || 0
    }));

    renderLines();
    showOnly(screenPrep);
  }catch(e){
    msg(prepMsg, "err", "Erreur API (orderLines).");
    showOnly(screenList);
  }
}

function renderLines(){
  linesDiv.innerHTML = "";
  let total=0, ok=0;

  orderLines.forEach(l=>{
    total += l.qty;
    ok += l.picked;

    const done = (l.picked >= l.qty);

    const d = document.createElement("div");
    d.className = "list-item";
    d.innerHTML = `
      <div class="kv">
        <div><strong>${l.name}</strong> <span>(${l.code})</span></div>
        <div>${done ? "‚úî" : ""}</div>
      </div>
      <div style="margin-top:6px;font-weight:800">${l.picked} / ${l.qty}</div>
      <button class="primary" onclick="startProductScan('${l.code}')">${done ? "D√©j√† OK" : "Scanner"} ${l.code}</button>
    `;
    linesDiv.appendChild(d);
  });

  progressEl.textContent = `Avancement : ${ok} / ${total}`;

  if(ok === total && total > 0){
    toFinishBtn.disabled = false;
    toFinishBtn.className = "success";
    msg(prepMsg, "info", "Commande pr√™te ‚úÖ (scanner le bac √† la fin).");
  }else{
    msg(prepMsg, "info", "Scanne les produits demand√©s.");
  }
}

/* ===== Scan produit: ouvre cam√©ra, lit un QR/Code produit et appelle pickScan c√¥t√© back ===== */
function startProductScan(code){
  scanMode = "product";
  scanProductCode = code;
  openScannerUI(`Scanne le produit ${code} (1 scan = 1 unit√©).`);
}

async function onProductDecoded(decodedText){
  const scanned = normalize(decodedText);

  // Strict: on accepte uniquement si le code scann√© = code attendu
  if(scanned !== scanProductCode){
    msg(prepMsg, "err", `Mauvais produit. Attendu: ${scanProductCode}, re√ßu: ${scanned}`);
    return;
  }

  try{
    // Appel back: d√©cr√©mente tampon + incr√©mente picked
    await apiPost({
      action: "pickScan",
      orderId: currentCmd,
      actor: ACTOR,
      code: scanProductCode,
      qty: 1
    });

    // Stop cam√©ra (√©vite double lecture)
    await stopScanner();

    // Recharge les lignes pour refl√©ter picked r√©el c√¥t√© serveur
    orderLines = await apiGet({ action:"orderLines", id: currentCmd });
    orderLines = (orderLines || []).map(l => ({
      code: l.code, name: l.name,
      qty: Number(l.qty)||0,
      picked: Number(l.picked)||0
    }));

    msg(prepMsg, "info", `OK: ${scanProductCode} valid√©.`);
    renderLines();
  }catch(e){
    msg(prepMsg, "err", e.message || "Erreur pickScan");
    // on ne stop pas forc√©ment, l'op√©rateur peut rescanner
  }
}

/* ================== FIN (scan bac) ================== */
toFinishBtn.onclick = () => openFinish(currentCmd);

function openFinish(cmdId){
  currentCmd = cmdId;
  scanMode = "bin";
  scanProductCode = null;

  msg(finishMsg, "info", "D√©marre la cam√©ra puis scanne le QR du bac.");
  showOnly(screenFinish);

  if(!isSecureContextOk()){
    msg(finishMsg, "err", "HTTPS requis (ou localhost) pour utiliser la cam√©ra.");
  }

  if(!qrScanner){
    qrScanner = new Html5Qrcode("qr-reader");
  }

  startCamBtn.disabled = false;
  startCamBtn.className = "primary";
  stopCamBtn.disabled = true;
  stopCamBtn.className = "disabled";
}

function openScannerUI(infoText){
  // on reste sur l'√©cran PREP, on utilise la m√™me zone qr-reader en screen-finish? non:
  // pour rester simple: on r√©utilise l'√©cran finish comme ‚Äúscanner‚Äù g√©n√©rique.
  // => On bascule sur screen-finish mais le message change.
  msg(finishMsg, "info", infoText);
  showOnly(screenFinish);

  if(!isSecureContextOk()){
    msg(finishMsg, "err", "HTTPS requis (ou localhost) pour utiliser la cam√©ra.");
    return;
  }
  if(!qrScanner){
    qrScanner = new Html5Qrcode("qr-reader");
  }

  startCamBtn.disabled = false;
  startCamBtn.className = "primary";
  stopCamBtn.disabled = true;
  stopCamBtn.className = "disabled";
}

async function startScanner(){
  if(cameraRunning) return;

  const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };

  try{
    cameraRunning = true;
    startCamBtn.disabled = true;
    startCamBtn.className = "disabled";
    stopCamBtn.disabled = false;
    stopCamBtn.className = "danger";

    await qrScanner.start(
      { facingMode: "environment" },
      config,
      (decodedText) => onDecoded(decodedText),
      () => {}
    );

  }catch(e){
    cameraRunning = false;
    startCamBtn.disabled = false;
    startCamBtn.className = "primary";
    stopCamBtn.disabled = true;
    stopCamBtn.className = "disabled";

    const err = (e && e.message) ? e.message : String(e);
    msg(finishMsg, "err",
      "Cam√©ra refus√©e ou indisponible. V√©rifie permission cam√©ra + HTTPS. D√©tail: " + err
    );
  }
}

async function stopScanner(){
  if(!qrScanner || !cameraRunning) return;
  try{ await qrScanner.stop(); }catch(_){}
  try{ await qrScanner.clear(); }catch(_){}
  cameraRunning = false;

  startCamBtn.disabled = false;
  startCamBtn.className = "primary";
  stopCamBtn.disabled = true;
  stopCamBtn.className = "disabled";
}

async function onDecoded(decodedText){
  if(scanMode === "product") return onProductDecoded(decodedText);
  if(scanMode === "bin") return onBinDecoded(decodedText);
}

async function onBinDecoded(decodedText){
  const bin = normalize(decodedText);

  try{
    await stopScanner();

    await apiPost({
      action: "orderDone",
      orderId: currentCmd,
      actor: ACTOR,
      bin
    });

    msg(finishMsg, "info", `‚úÖ Commande ${currentCmd} d√©pos√©e dans ${bin}.`);
    await loadOrders();
  }catch(e){
    msg(finishMsg, "err", e.message || "Erreur orderDone");
  }
}

startCamBtn.onclick = startScanner;
stopCamBtn.onclick = stopScanner;

function backToListFromFinish(){
  stopScanner();
  showOnly(screenList);
  loadOrders();
}

/* ================== NAV ================== */
function goBack(){
  stopScanner();
  currentCmd = null;
  showOnly(screenList);
  loadOrders();
}

/* INIT */
loadOrders();
</script>
</body>
</html>
